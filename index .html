<!DOCTYPE html>
<html>
<head>
    <title>Basic Ray Tracing Demo</title>
</head>
<body>
    <canvas id="raytracerCanvas" width="400" height="400"></canvas>

    <script>
        // Langkah 1: Setup Canvas
        const canvas = document.getElementById('raytracerCanvas');
        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(canvas.width, canvas.height);

        // Langkah 2: Definisi Kamera
        const camera = {
            position: { x: 0, y: 0, z: 0 },  // Posisi kamera di origin
            viewport: {
                width: 1.0,     // Lebar viewport
                height: 1.0,    // Tinggi viewport
                distance: 1.0   // Jarak dari kamera
            }
        };

        // Langkah 3: Definisi Bola dalam Scene
        const spheres = [
            {
                center: { x: 0, y: 0, z: -3 },
                radius: 1,
                color: { r: 255, g: 0, b: 0 }  // Warna merah
            },
            {
                center: { x: 0.5, y: -0.5, z: -2 },
                radius: 0.5,
                color: { r: 0, g: 0, b: 255 }  // Warna biru
            }
        ];

        // Langkah 4: Definisi Cahaya
        const light = {
            position: { x: 2, y: 1, z: 0 },
            intensity: 1.5
        };

        // Langkah 5: Fungsi Hitung Dot Product
        function dot(v1, v2) {
            return v1.x * v2.x + v1.y * v2.y + v1.z * v2.z;
        }

        // Langkah 6: Fungsi Interseksi Ray-Sphere
        function intersectSphere(rayOrigin, rayDirection, sphere) {
            const oc = {
                x: rayOrigin.x - sphere.center.x,
                y: rayOrigin.y - sphere.center.y,
                z: rayOrigin.z - sphere.center.z
            };
            
            const a = dot(rayDirection, rayDirection);
            const b = 2 * dot(oc, rayDirection);
            const c = dot(oc, oc) - sphere.radius * sphere.radius;
            
            const discriminant = b * b - 4 * a * c;
            
            if (discriminant < 0) {
                return Infinity; // Tidak ada interseksi
            }
            
            return (-b - Math.sqrt(discriminant)) / (2 * a);
        }

        // Langkah 7: Fungsi Trace Ray
        function traceRay(rayOrigin, rayDirection) {
            let closestT = Infinity;
            let closestSphere = null;
            
            // Cari interseksi terdekat
            for (const sphere of spheres) {
                const t = intersectSphere(rayOrigin, rayDirection, sphere);
                if (t < closestT && t > 0) {
                    closestT = t;
                    closestSphere = sphere;
                }
            }
            
            if (closestSphere) {
                // Hitung posisi interseksi
                const point = {
                    x: rayOrigin.x + closestT * rayDirection.x,
                    y: rayOrigin.y + closestT * rayDirection.y,
                    z: rayOrigin.z + closestT * rayDirection.z
                };
                
                // Hitung normal di titik interseksi
                const normal = {
                    x: point.x - closestSphere.center.x,
                    y: point.y - closestSphere.center.y,
                    z: point.z - closestSphere.center.z
                };
                
                // Normalisasi normal
                const length = Math.sqrt(dot(normal, normal));
                normal.x /= length;
                normal.y /= length;
                normal.z /= length;
                
                // Hitung arah cahaya
                const lightDir = {
                    x: light.position.x - point.x,
                    y: light.position.y - point.y,
                    z: light.position.z - point.z
                };
                
                // Normalisasi arah cahaya
                const lightLength = Math.sqrt(dot(lightDir, lightDir));
                lightDir.x /= lightLength;
                lightDir.y /= lightLength;
                lightDir.z /= lightLength;
                
                // Hitung difuse lighting
                const diffuse = Math.max(0, dot(normal, lightDir));
                
                // Gabungkan warna dengan lighting
                return {
                    r: Math.min(255, closestSphere.color.r * diffuse * light.intensity),
                    g: Math.min(255, closestSphere.color.g * diffuse * light.intensity),
                    b: Math.min(255, closestSphere.color.b * diffuse * light.intensity)
                };
            }
            
            // Warna latar belakang jika tidak ada interseksi
            return { r: 50, g: 50, b: 50 };
        }

        // Langkah 8: Render Loop
        for (let y = 0; y < canvas.height; y++) {
            for (let x = 0; x < canvas.width; x++) {
                // Hitung koordinat viewport
                const aspectRatio = canvas.width / canvas.height;
                const viewportX = ((x / canvas.width) - 0.5) * camera.viewport.width * aspectRatio;
                const viewportY = ((y / canvas.height) - 0.5) * camera.viewport.height;
                
                // Buat arah ray
                const rayDirection = {
                    x: viewportX,
                    y: viewportY,
                    z: -camera.viewport.distance
                };
                
                // Normalisasi arah ray
                const length = Math.sqrt(dot(rayDirection, rayDirection));
                rayDirection.x /= length;
                rayDirection.y /= length;
                rayDirection.z /= length;
                
                // Trace ray dan dapatkan warna
                const color = traceRay(camera.position, rayDirection);
                
                // Set pixel di imageData
                const index = (y * canvas.width + x) * 4;
                imageData.data[index] = color.r;
                imageData.data[index + 1] = color.g;
                imageData.data[index + 2] = color.b;
                imageData.data[index + 3] = 255; // Alpha channel
            }
        }

        // Langkah 9: Tampilkan gambar ke canvas
        ctx.putImageData(imageData, 0, 0);
    </script>
</body>
</html>